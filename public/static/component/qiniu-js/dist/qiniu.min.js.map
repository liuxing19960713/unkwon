{"version":3,"sources":["public/static/component/qiniu-js/dist/qiniu.js"],"names":["global","createCookie","key","value","exp","date","Date","setTime","getTime","expires","toGMTString","document","cookie","readCookie","nameEQ","ca","split","i","max","length","c","charAt","substring","indexOf","QiniuJsSDK","log","type","args","header","msg","that","stringifyJSON","detectIEVersion","console","unshift","apply","getElementById","innerHTML","makeLogFunc","code","func","toLowerCase","logger","window","level","Array","prototype","slice","call","arguments","this","v","div","createElement","all","getElementsByTagName","MUTE","FATA","ERROR","WARN","INFO","DEBUG","TRACE","property","hasOwnProperty","qiniuUploadUrl","location","protocol","qiniuUploadUrls","qiniuUpHosts","http","https","changeUrlTimes","resetUploadUrl","hosts","debug","isImage","url","test","getFileExtension","filename","tempArr","pop","utf8_encode","argString","start","end","string","utftext","stringl","n","c1","charCodeAt","enc","String","fromCharCode","RangeError","c2","base64_decode","data","o1","o2","o3","h1","h2","h3","h4","bits","b64","ac","tmp_arr","join","base64_encode","URLSafeBase64Encode","replace","URLSafeBase64Decode","createAjax","argument","XMLHttpRequest","ActiveXObject","parseJSON","JSON","parse","rx_dangerous","text","lastIndex","a","toString","eval","obj","stringify","map","strArr","len","push","trim","uploader","op","getHosts","result","host","getPutPolicy","uptoken","segments","ak","putPolicy","scope","bucket","getUpHosts","uphosts_url","ajax","ie","mOxie","Env","swf_url","flash_swf_url","open","onreadystatechange","readyState","status","res","responseText","up","error","bind","send","getUptoken","file","token","uptoken_url","tokenInfo","isExpired","getNewUpToken","setRequestHeader","tokenMap","getTimestamp","time","Math","ceil","serverTime","getResponseHeader","clientTime","serverDelay","deadline","uptoken_func","getFileKey","unique_names","save_key","getOption","settings","ext","name","id","log_level","domain","browse_button","navigator","userAgent","option","_Error_Handler","init","Error","_FileUploaded_Handler","FileUploaded","key_handler","Key","ctx","speedCalInfo","isResumeUpload","resumeFilesize","startTime","currentTime","BLOCK_BITS","MAX_CHUNK_SIZE","isSpecialSafari","browser","version","os","osVersion","chunk_size","runtimes","plupload","parseSize","defaultSetting","multipart_params","accept","extend","Uploader","params","get_new_uptoken","files","auto_start","OS","setTimeout","refresh","speed","directUpload","multipart_params_obj","x_vars","undefined","x_key","setOption","multipart","is_android_weixin_or_qq","max_file_size","ua","match","runtime","size","localFileInfo","localStorage","getItem","blockSize","now","before","percent","total","loaded","offset","removeItem","required_features","headers","Authorization","trace","timeUsed","fileUploaded","toFixed","info","response","leftSize","setItem","retries","unknow_error_retry","QUEUED","stop","err","errTip","FAILED","FILE_SIZE_ERROR","FILE_EXTENSION_ERROR","HTTP_ERROR","message","errorObj","errorText","e","SECURITY_ERROR","GENERIC_ERROR","IO_ERROR","INIT_ERROR","destroy","details","last_step","downtoken_url","ajax_downtoken","res_downtoken","info_extended","trigger","fname","x_val","x_vars_url","responseHeaders","getAllResponseHeaders","getUrl","encodeURI","imageView2","mode","w","h","q","format","imageUrl","imageMogr2","auto_orient","thumbnail","strip","gravity","crop","quality","rotate","blur","watermark","image","font","fontsize","fill","dissolve","dx","dy","imageInfo","xhr","exif","get","pipeline","arr","errOp","isArray","Object","fop","Qiniu"],"mappings":"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","file":"qiniu.min.js","sourcesContent":["/*!\n * qiniu-js-sdk v1.0.18\n *\n * Copyright 2015 by Qiniu\n * Released under GPL V2 License.\n *\n * GitHub: http://github.com/qiniu/js-sdk\n *\n * Date: 2017-2-6\n*/\n\n/*global plupload ,mOxie*/\n/*global ActiveXObject */\n/*exported Qiniu */\n/*exported QiniuJsSDK */\n\n;(function( global ){\n\n/**\n * Creates new cookie or removes cookie with negative expiration\n * @param  key       The key or identifier for the store\n * @param  value     Contents of the store\n * @param  exp       Expiration - creation defaults to 30 days\n */\nfunction createCookie(key, value, exp) {\n    var date = new Date();\n    date.setTime(date.getTime() + (exp * 24 * 60 * 60 * 1000));\n    var expires = \"; expires=\" + date.toGMTString();\n    document.cookie = key + \"=\" + value + expires + \"; path=/\";\n}\n\n/**\n * Returns contents of cookie\n * @param  key       The key or identifier for the store\n */\nfunction readCookie(key) {\n    var nameEQ = key + \"=\";\n    var ca = document.cookie.split(';');\n    for (var i = 0, max = ca.length; i < max; i++) {\n        var c = ca[i];\n        while (c.charAt(0) === ' ') {\n            c = c.substring(1, c.length);\n        }\n        if (c.indexOf(nameEQ) === 0) {\n            return c.substring(nameEQ.length, c.length);\n        }\n    }\n    return null;\n}\n\n// if current browser is not support localStorage\n// use cookie to make a polyfill\nif ( !window.localStorage ) {\n    window.localStorage = {\n        setItem: function (key, value) {\n            createCookie(key, value, 30);\n        },\n        getItem: function (key) {\n            return readCookie(key);\n        },\n        removeItem: function (key) {\n            createCookie(key, '', -1);\n        }\n    };\n}\n\nfunction QiniuJsSDK() {\n\n    var that = this;\n\n    /**\n     * detect IE version\n     * if current browser is not IE\n     *     it will return false\n     * else\n     *     it will return version of current IE browser\n     * @return {Number|Boolean} IE version or false\n     */\n    this.detectIEVersion = function() {\n        var v = 4,\n            div = document.createElement('div'),\n            all = div.getElementsByTagName('i');\n        while (\n            div.innerHTML = '<!--[if gt IE ' + v + ']><i></i><![endif]-->',\n            all[0]\n        ) {\n            v++;\n        }\n        return v > 4 ? v : false;\n    };\n\n    var logger = {\n        MUTE: 0,\n        FATA: 1,\n        ERROR: 2,\n        WARN: 3,\n        INFO: 4,\n        DEBUG: 5,\n        TRACE: 6,\n        level: 0\n    };\n\n    function log(type, args){\n        var header = \"[qiniu-js-sdk][\"+type+\"]\";\n        var msg = header;\n        for (var i = 0; i < args.length; i++) {\n            if (typeof args[i] === \"string\") {\n                msg += \" \" + args[i];\n            } else {\n                msg += \" \" + that.stringifyJSON(args[i]);\n            }\n        }\n        if (that.detectIEVersion()) {\n            // http://stackoverflow.com/questions/5538972/console-log-apply-not-working-in-ie9\n            //var log = Function.prototype.bind.call(console.log, console);\n            //log.apply(console, args);\n            console.log(msg);\n        }else{\n            args.unshift(header);\n            console.log.apply(console, args);\n        }\n        if (document.getElementById('qiniu-js-sdk-log')) {\n            document.getElementById('qiniu-js-sdk-log').innerHTML += '<p>'+msg+'</p>';\n        }\n    }\n\n    function makeLogFunc(code){\n        var func = code.toLowerCase();\n        logger[func] = function(){\n            // logger[func].history = logger[func].history || [];\n            // logger[func].history.push(arguments);\n            if(window.console && window.console.log && logger.level>=logger[code]){\n                var args = Array.prototype.slice.call(arguments);\n                log(func,args);\n            }\n        };\n    }\n\n    for (var property in logger){\n        if (logger.hasOwnProperty(property) && (typeof logger[property]) === \"number\" && !logger.hasOwnProperty(property.toLowerCase())) {\n            makeLogFunc(property);\n        }\n    }\n\n\n    var qiniuUploadUrl;\n    if (window.location.protocol === 'https:') {\n        qiniuUploadUrl = 'https://up.qbox.me';\n    } else {\n        qiniuUploadUrl = 'http://upload.qiniu.com';\n    }\n\n    /**\n     * qiniu upload urls\n     * 'qiniuUploadUrls' is used to change target when current url is not avaliable\n     * @type {Array}\n     */\n    var qiniuUploadUrls = [\n        \"http://upload.qiniu.com\",\n        \"http://up.qiniu.com\"\n    ];\n\n    var qiniuUpHosts = {\n       \"http\": [\n           \"http://upload.qiniu.com\",\n           \"http://up.qiniu.com\"\n       ],\n       \"https\": [\n           \"https://up.qbox.me\"\n       ]\n    };\n\n    var changeUrlTimes = 0;\n\n    /**\n     * reset upload url\n     * if current page protocal is https\n     *     it will always return 'https://up.qbox.me'\n     * else\n     *     it will set 'qiniuUploadUrl' value with 'qiniuUploadUrls' looply\n     */\n    this.resetUploadUrl = function(){\n\tvar hosts = window.location.protocol === 'https:' ? qiniuUpHosts.https : qiniuUpHosts.http;\n\tvar i = changeUrlTimes % hosts.length;\n\tqiniuUploadUrl = hosts[i];\n\tchangeUrlTimes++;\n\tlogger.debug('resetUploadUrl: '+qiniuUploadUrl);\n    };\n\n    // this.resetUploadUrl();\n\n\n    /**\n     * is image\n     * @param  {String}  url of a file\n     * @return {Boolean} file is a image or not\n     */\n    this.isImage = function(url) {\n        url = url.split(/[?#]/)[0];\n        return (/\\.(png|jpg|jpeg|gif|bmp)$/i).test(url);\n    };\n\n    /**\n     * get file extension\n     * @param  {String} filename\n     * @return {String} file extension\n     * @example\n     *     input: test.txt\n     *     output: txt\n     */\n    this.getFileExtension = function(filename) {\n        var tempArr = filename.split(\".\");\n        var ext;\n        if (tempArr.length === 1 || (tempArr[0] === \"\" && tempArr.length === 2)) {\n            ext = \"\";\n        } else {\n            ext = tempArr.pop().toLowerCase(); //get the extension and make it lower-case\n        }\n        return ext;\n    };\n\n    /**\n     * encode string by utf8\n     * @param  {String} string to encode\n     * @return {String} encoded string\n     */\n    this.utf8_encode = function(argString) {\n        // http://kevin.vanzonneveld.net\n        // +   original by: Webtoolkit.info (http://www.webtoolkit.info/)\n        // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n        // +   improved by: sowberry\n        // +    tweaked by: Jack\n        // +   bugfixed by: Onno Marsman\n        // +   improved by: Yves Sucaet\n        // +   bugfixed by: Onno Marsman\n        // +   bugfixed by: Ulrich\n        // +   bugfixed by: Rafal Kukawski\n        // +   improved by: kirilloid\n        // +   bugfixed by: kirilloid\n        // *     example 1: this.utf8_encode('Kevin van Zonneveld');\n        // *     returns 1: 'Kevin van Zonneveld'\n\n        if (argString === null || typeof argString === 'undefined') {\n            return '';\n        }\n\n        var string = (argString + ''); // .replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n');\n        var utftext = '',\n            start, end, stringl = 0;\n\n        start = end = 0;\n        stringl = string.length;\n        for (var n = 0; n < stringl; n++) {\n            var c1 = string.charCodeAt(n);\n            var enc = null;\n\n            if (c1 < 128) {\n                end++;\n            } else if (c1 > 127 && c1 < 2048) {\n                enc = String.fromCharCode(\n                    (c1 >> 6) | 192, (c1 & 63) | 128\n                );\n            } else if (c1 & 0xF800 ^ 0xD800 > 0) {\n                enc = String.fromCharCode(\n                    (c1 >> 12) | 224, ((c1 >> 6) & 63) | 128, (c1 & 63) | 128\n                );\n            } else { // surrogate pairs\n                if (c1 & 0xFC00 ^ 0xD800 > 0) {\n                    throw new RangeError('Unmatched trail surrogate at ' + n);\n                }\n                var c2 = string.charCodeAt(++n);\n                if (c2 & 0xFC00 ^ 0xDC00 > 0) {\n                    throw new RangeError('Unmatched lead surrogate at ' + (n - 1));\n                }\n                c1 = ((c1 & 0x3FF) << 10) + (c2 & 0x3FF) + 0x10000;\n                enc = String.fromCharCode(\n                    (c1 >> 18) | 240, ((c1 >> 12) & 63) | 128, ((c1 >> 6) & 63) | 128, (c1 & 63) | 128\n                );\n            }\n            if (enc !== null) {\n                if (end > start) {\n                    utftext += string.slice(start, end);\n                }\n                utftext += enc;\n                start = end = n + 1;\n            }\n        }\n\n        if (end > start) {\n            utftext += string.slice(start, stringl);\n        }\n\n        return utftext;\n    };\n\n    this.base64_decode = function (data) {\n        // http://kevin.vanzonneveld.net\n        // +   original by: Tyler Akins (http://rumkin.com)\n        // +   improved by: Thunder.m\n        // +      input by: Aman Gupta\n        // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n        // +   bugfixed by: Onno Marsman\n        // +   bugfixed by: Pellentesque Malesuada\n        // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n        // +      input by: Brett Zamir (http://brett-zamir.me)\n        // +   bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n        // *     example 1: base64_decode('S2V2aW4gdmFuIFpvbm5ldmVsZA==');\n        // *     returns 1: 'Kevin van Zonneveld'\n        // mozilla has this native\n        // - but breaks in 2.0.0.12!\n        //if (typeof this.window['atob'] == 'function') {\n        //    return atob(data);\n        //}\n        var b64 = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n        var o1, o2, o3, h1, h2, h3, h4, bits, i = 0,\n        ac = 0,\n        dec = \"\",\n        tmp_arr = [];\n\n        if (!data) {\n            return data;\n        }\n\n        data += '';\n\n        do { // unpack four hexets into three octets using index points in b64\n            h1 = b64.indexOf(data.charAt(i++));\n            h2 = b64.indexOf(data.charAt(i++));\n            h3 = b64.indexOf(data.charAt(i++));\n            h4 = b64.indexOf(data.charAt(i++));\n\n            bits = h1 << 18 | h2 << 12 | h3 << 6 | h4;\n\n            o1 = bits >> 16 & 0xff;\n            o2 = bits >> 8 & 0xff;\n            o3 = bits & 0xff;\n\n            if (h3 === 64) {\n                tmp_arr[ac++] = String.fromCharCode(o1);\n            } else if (h4 === 64) {\n                tmp_arr[ac++] = String.fromCharCode(o1, o2);\n            } else {\n                tmp_arr[ac++] = String.fromCharCode(o1, o2, o3);\n            }\n        } while (i < data.length);\n\n        dec = tmp_arr.join('');\n\n        return dec;\n    };\n\n    /**\n     * encode data by base64\n     * @param  {String} data to encode\n     * @return {String} encoded data\n     */\n    this.base64_encode = function(data) {\n        // http://kevin.vanzonneveld.net\n        // +   original by: Tyler Akins (http://rumkin.com)\n        // +   improved by: Bayron Guevara\n        // +   improved by: Thunder.m\n        // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n        // +   bugfixed by: Pellentesque Malesuada\n        // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n        // -    depends on: this.utf8_encode\n        // *     example 1: this.base64_encode('Kevin van Zonneveld');\n        // *     returns 1: 'S2V2aW4gdmFuIFpvbm5ldmVsZA=='\n        // mozilla has this native\n        // - but breaks in 2.0.0.12!\n        //if (typeof this.window['atob'] == 'function') {\n        //    return atob(data);\n        //}\n        var b64 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';\n        var o1, o2, o3, h1, h2, h3, h4, bits, i = 0,\n            ac = 0,\n            enc = '',\n            tmp_arr = [];\n\n        if (!data) {\n            return data;\n        }\n\n        data = this.utf8_encode(data + '');\n\n        do { // pack three octets into four hexets\n            o1 = data.charCodeAt(i++);\n            o2 = data.charCodeAt(i++);\n            o3 = data.charCodeAt(i++);\n\n            bits = o1 << 16 | o2 << 8 | o3;\n\n            h1 = bits >> 18 & 0x3f;\n            h2 = bits >> 12 & 0x3f;\n            h3 = bits >> 6 & 0x3f;\n            h4 = bits & 0x3f;\n\n            // use hexets to index into b64, and append result to encoded string\n            tmp_arr[ac++] = b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);\n        } while (i < data.length);\n\n        enc = tmp_arr.join('');\n\n        switch (data.length % 3) {\n            case 1:\n                enc = enc.slice(0, -2) + '==';\n                break;\n            case 2:\n                enc = enc.slice(0, -1) + '=';\n                break;\n        }\n\n        return enc;\n    };\n\n    /**\n     * encode string in url by base64\n     * @param {String} string in url\n     * @return {String} encoded string\n     */\n    this.URLSafeBase64Encode = function(v) {\n        v = this.base64_encode(v);\n        return v.replace(/\\//g, '_').replace(/\\+/g, '-');\n    };\n\n    this.URLSafeBase64Decode = function(v) {\n        v = v.replace(/_/g, '/').replace(/-/g, '+');\n        return this.base64_decode(v);\n    };\n\n    // TODO: use mOxie\n    /**\n     * craete object used to AJAX\n     * @return {Object}\n     */\n    this.createAjax = function(argument) {\n        var xmlhttp = {};\n        if (window.XMLHttpRequest) {\n            xmlhttp = new XMLHttpRequest();\n        } else {\n            xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");\n        }\n        return xmlhttp;\n    };\n\n    // TODO: enhance IE compatibility\n    /**\n     * parse json string to javascript object\n     * @param  {String} json string\n     * @return {Object} object\n     */\n    this.parseJSON = function(data) {\n        // Attempt to parse using the native JSON parser first\n        if (window.JSON && window.JSON.parse) {\n            return window.JSON.parse(data);\n        }\n\n        //var rx_one = /^[\\],:{}\\s]*$/,\n        //    rx_two = /\\\\(?:[\"\\\\\\/bfnrt]|u[0-9a-fA-F]{4})/g,\n        //    rx_three = /\"[^\"\\\\\\n\\r]*\"|true|false|null|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?/g,\n        //    rx_four = /(?:^|:|,)(?:\\s*\\[)+/g,\n        var    rx_dangerous = /[\\u0000\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]/g;\n\n        //var json;\n\n        var text = String(data);\n        rx_dangerous.lastIndex = 0;\n        if(rx_dangerous.test(text)){\n            text = text.replace(rx_dangerous, function(a){\n               return '\\\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);\n            });\n        }\n\n        // todo 使用一下判断,增加安全性\n        //if (\n        //    rx_one.test(\n        //        text\n        //            .replace(rx_two, '@')\n        //            .replace(rx_three, ']')\n        //            .replace(rx_four, '')\n        //    )\n        //) {\n        //    return eval('(' + text + ')');\n        //}\n\n        return eval('('+text+')');\n    };\n\n    /**\n     * parse javascript object to json string\n     * @param  {Object} object\n     * @return {String} json string\n     */\n    this.stringifyJSON = function(obj) {\n        // Attempt to parse using the native JSON parser first\n        if (window.JSON && window.JSON.stringify) {\n            return window.JSON.stringify(obj);\n        }\n        switch (typeof (obj)) {\n            case 'string':\n                return '\"' + obj.replace(/([\"\\\\])/g, '\\\\$1') + '\"';\n            case 'array':\n                return '[' + obj.map(that.stringifyJSON).join(',') + ']';\n            case 'object':\n                if (obj instanceof Array) {\n                    var strArr = [];\n                    var len = obj.length;\n                    for (var i = 0; i < len; i++) {\n                        strArr.push(that.stringifyJSON(obj[i]));\n                    }\n                    return '[' + strArr.join(',') + ']';\n                } else if (obj === null) {\n                    return 'null';\n                } else {\n                    var string = [];\n                    for (var property in obj) {\n                        if (obj.hasOwnProperty(property)) {\n                            string.push(that.stringifyJSON(property) + ':' + that.stringifyJSON(obj[property]));\n                        }\n                    }\n                    return '{' + string.join(',') + '}';\n                }\n                break;\n            case 'number':\n                return obj;\n            case false:\n                return obj;\n            case 'boolean':\n                return obj;\n        }\n    };\n\n    /**\n     * trim space beside text\n     * @param  {String} untrimed string\n     * @return {String} trimed string\n     */\n    this.trim = function(text) {\n        return text === null ? \"\" : text.replace(/^\\s+|\\s+$/g, '');\n    };\n\n    /**\n     * create a uploader by QiniuJsSDK\n     * @param  {object} options to create a new uploader\n     * @return {object} uploader\n     */\n    this.uploader = function(op) {\n\n        /********** inner function define start **********/\n\n        // according the different condition to reset chunk size\n        // and the upload strategy according with the chunk size\n        // when chunk size is zero will cause to direct upload\n        // see the statement binded on 'BeforeUpload' event\n        var reset_chunk_size = function() {\n            var ie = that.detectIEVersion();\n            var BLOCK_BITS, MAX_CHUNK_SIZE, chunk_size;\n            // case Safari 5、Windows 7、iOS 7 set isSpecialSafari to true\n            var isSpecialSafari = (mOxie.Env.browser === \"Safari\" && mOxie.Env.version <= 5 && mOxie.Env.os === \"Windows\" && mOxie.Env.osVersion === \"7\") || (mOxie.Env.browser === \"Safari\" && mOxie.Env.os === \"iOS\" && mOxie.Env.osVersion === \"7\");\n            // case IE 9-，chunk_size is not empty and flash is included in runtimes\n            // set op.chunk_size to zero\n            //if (ie && ie < 9 && op.chunk_size && op.runtimes.indexOf('flash') >= 0) {\n            if (ie && ie < 9 && op.chunk_size && op.runtimes.indexOf('flash') >= 0) {\n                //  link: http://www.plupload.com/docs/Frequently-Asked-Questions#when-to-use-chunking-and-when-not\n                //  when plupload chunk_size setting is't null ,it cause bug in ie8/9  which runs  flash runtimes (not support html5) .\n                op.chunk_size = 0;\n            } else if (isSpecialSafari) {\n                // win7 safari / iOS7 safari have bug when in chunk upload mode\n                // reset chunk_size to 0\n                // disable chunk in special version safari\n                op.chunk_size = 0;\n            } else {\n                BLOCK_BITS = 20;\n                MAX_CHUNK_SIZE = 4 << BLOCK_BITS; //4M\n\n                chunk_size = plupload.parseSize(op.chunk_size);\n                if (chunk_size > MAX_CHUNK_SIZE) {\n                    op.chunk_size = MAX_CHUNK_SIZE;\n                }\n                // qiniu service  max_chunk_size is 4m\n                // reset chunk_size to max_chunk_size(4m) when chunk_size > 4m\n            }\n            // if op.chunk_size set 0 will be cause to direct upload\n        };\n\n        var getHosts = function(hosts) {\n            var result = [];\n            for (var i = 0; i < hosts.length; i++) {\n                var host = hosts[i];\n                if (host.indexOf('-H') === 0) {\n                    result.push(host.split(' ')[2]);\n                } else {\n                    result.push(host);\n                }\n            }\n            return result;\n        };\n\n        var getPutPolicy = function (uptoken) {\n            var segments = uptoken.split(\":\");\n            var ak = segments[0];\n            var putPolicy = that.parseJSON(that.URLSafeBase64Decode(segments[2]));\n            putPolicy.ak = ak;\n            if (putPolicy.scope.indexOf(\":\") >= 0) {\n                putPolicy.bucket = putPolicy.scope.split(\":\")[0];\n                putPolicy.key = putPolicy.scope.split(\":\")[1];\n            } else {\n                putPolicy.bucket = putPolicy.scope;\n            }\n            return putPolicy;\n        };\n\n        var getUpHosts = function(uptoken) {\n            var putPolicy = getPutPolicy(uptoken);\n            // var uphosts_url = \"//uc.qbox.me/v1/query?ak=\"+ak+\"&bucket=\"+putPolicy.scope;\n            // IE 9- is not support protocal relative url\n            var uphosts_url = window.location.protocol + \"//uc.qbox.me/v1/query?ak=\" + putPolicy.ak + \"&bucket=\" + putPolicy.bucket;\n            logger.debug(\"putPolicy: \", putPolicy);\n            logger.debug(\"get uphosts from: \", uphosts_url);\n            var ie = that.detectIEVersion();\n            var ajax;\n            if (ie && ie <= 9) {\n                ajax = new mOxie.XMLHttpRequest();\n                mOxie.Env.swf_url = op.flash_swf_url;\n            }else{\n                ajax = that.createAjax();\n            }\n            ajax.open('GET', uphosts_url, true);\n            var onreadystatechange = function(){\n                logger.debug(\"ajax.readyState: \", ajax.readyState);\n                if (ajax.readyState === 4) {\n                    logger.debug(\"ajax.status: \", ajax.status);\n                    if (ajax.status < 400) {\n                        var res = that.parseJSON(ajax.responseText);\n                        qiniuUpHosts.http = getHosts(res.http.up);\n                        qiniuUpHosts.https = getHosts(res.https.up);\n                        logger.debug(\"get new uphosts: \", qiniuUpHosts);\n                        that.resetUploadUrl();\n                    } else {\n                        logger.error(\"get uphosts error: \", ajax.responseText);\n                    }\n                }\n            };\n            if (ie && ie <= 9) {\n                ajax.bind('readystatechange', onreadystatechange);\n            }else{\n                ajax.onreadystatechange = onreadystatechange;\n            }\n            ajax.send();\n            // ajax.send();\n            // if (ajax.status < 400) {\n            //     var res = that.parseJSON(ajax.responseText);\n            //     qiniuUpHosts.http = getHosts(res.http.up);\n            //     qiniuUpHosts.https = getHosts(res.https.up);\n            //     logger.debug(\"get new uphosts: \", qiniuUpHosts);\n            //     that.resetUploadUrl();\n            // } else {\n            //     logger.error(\"get uphosts error: \", ajax.responseText);\n            // }\n            return;\n        };\n\n        var getUptoken = function(file) {\n            if (!that.token || (op.uptoken_url && that.tokenInfo.isExpired())) {\n                return getNewUpToken(file);\n            } else {\n                return that.token;\n            }\n        };\n\n        // getNewUptoken maybe called at Init Event or BeforeUpload Event\n        // case Init Event, the file param of getUptken will be set a null value\n        // if op.uptoken has value, set uptoken with op.uptoken\n        // else if op.uptoken_url has value, set uptoken from op.uptoken_url\n        // else if op.uptoken_func has value, set uptoken by result of op.uptoken_func\n        var getNewUpToken = function(file) {\n            if (op.uptoken) {\n                that.token = op.uptoken;\n            } else if (op.uptoken_url) {\n                logger.debug(\"get uptoken from: \", that.uptoken_url);\n                // TODO: use mOxie\n                var ajax = that.createAjax();\n                ajax.open('GET', that.uptoken_url, false);\n                ajax.setRequestHeader(\"If-Modified-Since\", \"0\");\n                // ajax.onreadystatechange = function() {\n                //     if (ajax.readyState === 4 && ajax.status === 200) {\n                //         var res = that.parseJSON(ajax.responseText);\n                //         that.token = res.uptoken;\n                //     }\n                // };\n                ajax.send();\n                if (ajax.status === 200) {\n                    var res = that.parseJSON(ajax.responseText);\n                    that.token = res.uptoken;\n                    var segments = that.token.split(\":\");\n                    var putPolicy = that.parseJSON(that.URLSafeBase64Decode(segments[2]));\n                    if (!that.tokenMap) {\n                        that.tokenMap = {};\n                    }\n                    var getTimestamp = function(time) {\n                        return Math.ceil(time.getTime()/1000);\n                    };\n                    var serverTime = getTimestamp(new Date(ajax.getResponseHeader(\"date\")));\n                    var clientTime = getTimestamp(new Date());\n                    that.tokenInfo = {\n                        serverDelay: clientTime - serverTime,\n                        deadline: putPolicy.deadline,\n                        isExpired: function() {\n                            var leftTime = this.deadline - getTimestamp(new Date()) + this.serverDelay;\n                            return leftTime < 600;\n                        }\n                    };\n                    logger.debug(\"get new uptoken: \", that.token);\n                    logger.debug(\"get token info: \", that.tokenInfo);\n                } else {\n                    logger.error(\"get uptoken error: \", ajax.responseText);\n                }\n            } else if (op.uptoken_func) {\n                logger.debug(\"get uptoken from uptoken_func\");\n                that.token = op.uptoken_func(file);\n                logger.debug(\"get new uptoken: \", that.token);\n            } else {\n                logger.error(\"one of [uptoken, uptoken_url, uptoken_func] settings in options is required!\");\n            }\n            if (that.token) {\n                getUpHosts(that.token);\n            }\n            return that.token;\n        };\n\n        // get file key according with the user passed options\n        var getFileKey = function(up, file, func) {\n            // WARNING\n            // When you set the key in putPolicy by \"scope\": \"bucket:key\"\n            // You should understand the risk of override a file in the bucket\n            // So the code below that automatically get key from uptoken has been commented\n            // var putPolicy = getPutPolicy(that.token)\n            // if (putPolicy.key) {\n            //     logger.debug(\"key is defined in putPolicy.scope: \", putPolicy.key)\n            //     return putPolicy.key\n            // }\n            var key = '',\n                unique_names = false;\n            if (!op.save_key) {\n                unique_names = up.getOption && up.getOption('unique_names');\n                unique_names = unique_names || (up.settings && up.settings.unique_names);\n                if (unique_names) {\n                    var ext = that.getFileExtension(file.name);\n                    key = ext ? file.id + '.' + ext : file.id;\n                } else if (typeof func === 'function') {\n                    key = func(up, file);\n                } else {\n                    key = file.name;\n                }\n            }\n            return key;\n        };\n\n        /********** inner function define end **********/\n\n        if (op.log_level) {\n            logger.level = op.log_level;\n        }\n\n        if (!op.domain) {\n            throw 'domain setting in options is required!';\n        }\n\n        if (!op.browse_button) {\n            throw 'browse_button setting in options is required!';\n        }\n\n        if (!op.uptoken && !op.uptoken_url && !op.uptoken_func) {\n            throw 'one of [uptoken, uptoken_url, uptoken_func] settings in options is required!';\n        }\n\n        logger.debug(\"init uploader start\");\n\n        logger.debug(\"environment: \", mOxie.Env);\n\n        logger.debug(\"userAgent: \", navigator.userAgent);\n\n        var option = {};\n\n        // hold the handler from user passed options\n        var _Error_Handler = op.init && op.init.Error;\n        var _FileUploaded_Handler = op.init && op.init.FileUploaded;\n\n        // replace the handler for intercept\n        op.init.Error = function() {};\n        op.init.FileUploaded = function() {};\n\n        that.uptoken_url = op.uptoken_url;\n        that.token = '';\n        that.key_handler = typeof op.init.Key === 'function' ? op.init.Key : '';\n        this.domain = op.domain;\n        // TODO: ctx is global in scope of a uploader instance\n        // this maybe cause error\n        var ctx = '';\n        var speedCalInfo = {\n            isResumeUpload: false,\n            resumeFilesize: 0,\n            startTime: '',\n            currentTime: ''\n        };\n\n        reset_chunk_size();\n        logger.debug(\"invoke reset_chunk_size()\");\n        logger.debug(\"op.chunk_size: \", op.chunk_size);\n\n        var defaultSetting = {\n            url: qiniuUploadUrl,\n            multipart_params: {\n                token: ''\n            }\n        };\n        var ie = that.detectIEVersion();\n        // case IE 9-\n        // add accept in multipart params\n        if (ie && ie <= 9) {\n            defaultSetting.multipart_params.accept = 'text/plain; charset=utf-8';\n            logger.debug(\"add accept text/plain in multipart params\");\n        }\n\n        // compose options with user passed options and default setting\n        plupload.extend(option, op, defaultSetting);\n\n        logger.debug(\"option: \", option);\n\n        // create a new uploader with composed options\n        var uploader = new plupload.Uploader(option);\n\n        logger.debug(\"new plupload.Uploader(option)\");\n\n        // bind getNewUpToken to 'Init' event\n        uploader.bind('Init', function(up, params) {\n            logger.debug(\"Init event activated\");\n            // if op.get_new_uptoken is not true\n            //      invoke getNewUptoken when uploader init\n            // else\n            //      getNewUptoken everytime before a new file upload\n            if(!op.get_new_uptoken){\n                getNewUpToken(null);\n            }\n            //getNewUpToken(null);\n        });\n\n        logger.debug(\"bind Init event\");\n\n        // bind 'FilesAdded' event\n        // when file be added and auto_start has set value\n        // uploader will auto start upload the file\n        uploader.bind('FilesAdded', function(up, files) {\n            logger.debug(\"FilesAdded event activated\");\n            var auto_start = up.getOption && up.getOption('auto_start');\n            auto_start = auto_start || (up.settings && up.settings.auto_start);\n            logger.debug(\"auto_start: \", auto_start);\n            logger.debug(\"files: \", files);\n\n            // detect is iOS\n            var is_ios = function (){\n                if(mOxie.Env.OS.toLowerCase()===\"ios\") {\n                    return true;\n                } else {\n                    return false;\n                }\n            };\n\n            // if current env os is iOS change file name to [time].[ext]\n            if (is_ios()) {\n                for (var i = 0; i < files.length; i++) {\n                    var file = files[i];\n                    var ext = that.getFileExtension(file.name);\n                    file.name = file.id + \".\" + ext;\n                }\n            }\n\n            if (auto_start) {\n                setTimeout(function(){\n                    up.start();\n                    logger.debug(\"invoke up.start()\");\n                }, 0);\n                // up.start();\n                // plupload.each(files, function(i, file) {\n                //     up.start();\n                //     logger.debug(\"invoke up.start()\")\n                //     logger.debug(\"file: \", file);\n                // });\n            }\n            up.refresh(); // Reposition Flash/Silverlight\n        });\n\n        logger.debug(\"bind FilesAdded event\");\n\n        // bind 'BeforeUpload' event\n        // intercept the process of upload\n        // - prepare uptoken\n        // - according the chunk size to make differnt upload strategy\n        // - resume upload with the last breakpoint of file\n        uploader.bind('BeforeUpload', function(up, file) {\n            logger.debug(\"BeforeUpload event activated\");\n            // add a key named speed for file object\n            file.speed = file.speed || 0;\n            ctx = '';\n\n            if(op.get_new_uptoken){\n                getNewUpToken(file);\n            }\n\n            var directUpload = function(up, file, func) {\n                speedCalInfo.startTime = new Date().getTime();\n                var multipart_params_obj;\n                if (op.save_key) {\n                    multipart_params_obj = {\n                        'token': that.token\n                    };\n                } else {\n                    multipart_params_obj = {\n                        'key': getFileKey(up, file, func),\n                        'token': that.token\n                    };\n                }\n                var ie = that.detectIEVersion();\n                // case IE 9-\n                // add accept in multipart params\n                if (ie && ie <= 9) {\n                    multipart_params_obj.accept = 'text/plain; charset=utf-8';\n                    logger.debug(\"add accept text/plain in multipart params\");\n                }\n\n                logger.debug(\"directUpload multipart_params_obj: \", multipart_params_obj);\n\n                var x_vars = op.x_vars;\n                if (x_vars !== undefined && typeof x_vars === 'object') {\n                    for (var x_key in x_vars) {\n                        if (x_vars.hasOwnProperty(x_key)) {\n                            if (typeof x_vars[x_key] === 'function') {\n                                multipart_params_obj['x:' + x_key] = x_vars[x_key](up, file);\n                            } else if (typeof x_vars[x_key] !== 'object') {\n                                multipart_params_obj['x:' + x_key] = x_vars[x_key];\n                            }\n                        }\n                    }\n                }\n\n                up.setOption({\n                    'url': qiniuUploadUrl,\n                    'multipart': true,\n                    'chunk_size': is_android_weixin_or_qq() ? op.max_file_size : undefined,\n                    'multipart_params': multipart_params_obj\n                });\n            };\n\n            // detect is weixin or qq inner browser\n            var is_android_weixin_or_qq = function (){\n                var ua = navigator.userAgent.toLowerCase();\n                if((ua.match(/MicroMessenger/i) || mOxie.Env.browser === \"QQBrowser\" || ua.match(/V1_AND_SQ/i)) && mOxie.Env.OS.toLowerCase()===\"android\") {\n                    return true;\n                } else {\n                    return false;\n                }\n            };\n\n            var chunk_size = up.getOption && up.getOption('chunk_size');\n            chunk_size = chunk_size || (up.settings && up.settings.chunk_size);\n\n            logger.debug(\"uploader.runtime: \",uploader.runtime);\n            logger.debug(\"chunk_size: \",chunk_size);\n\n            // TODO: flash support chunk upload\n            if ((uploader.runtime === 'html5' || uploader.runtime === 'flash') && chunk_size) {\n                if (file.size < chunk_size || is_android_weixin_or_qq()) {\n                    logger.debug(\"directUpload because file.size < chunk_size || is_android_weixin_or_qq()\");\n                    // direct upload if file size is less then the chunk size\n                    directUpload(up, file, that.key_handler);\n                } else {\n                    // TODO: need a polifill to make it work in IE 9-\n                    // ISSUE: if file.name is existed in localStorage\n                    // but not the same file maybe cause error\n                    var localFileInfo = localStorage.getItem(file.name);\n                    var blockSize = chunk_size;\n                    if (localFileInfo) {\n                        // TODO: although only the html5 runtime will enter this statement\n                        // but need uniform way to make convertion between string and json\n                        localFileInfo = that.parseJSON(localFileInfo);\n                        var now = (new Date()).getTime();\n                        var before = localFileInfo.time || 0;\n                        var aDay = 24 * 60 * 60 * 1000; //  milliseconds of one day\n                        // if the last upload time is within one day\n                        //      will upload continuously follow the last breakpoint\n                        // else\n                        //      will reupload entire file\n                        if (now - before < aDay) {\n\n                            if (localFileInfo.percent !== 100) {\n                                if (file.size === localFileInfo.total) {\n                                    // TODO: if file.name and file.size is the same\n                                    // but not the same file will cause error\n                                    file.percent = localFileInfo.percent;\n                                    file.loaded = localFileInfo.offset;\n                                    ctx = localFileInfo.ctx;\n\n                                    // set speed info\n                                    speedCalInfo.isResumeUpload = true;\n                                    speedCalInfo.resumeFilesize = localFileInfo.offset;\n\n                                    // set block size\n                                    if (localFileInfo.offset + blockSize > file.size) {\n                                        blockSize = file.size - localFileInfo.offset;\n                                    }\n                                } else {\n                                    // remove file info when file.size is conflict with file info\n                                    localStorage.removeItem(file.name);\n                                }\n\n                            } else {\n                                // remove file info when upload percent is 100%\n                                // avoid 499 bug\n                                localStorage.removeItem(file.name);\n                            }\n                        } else {\n                            // remove file info when last upload time is over one day\n                            localStorage.removeItem(file.name);\n                        }\n                    }\n                    speedCalInfo.startTime = new Date().getTime();\n                    var multipart_params_obj = {};\n                    var ie = that.detectIEVersion();\n                    // case IE 9-\n                    // add accept in multipart params\n                    if (ie && ie <= 9) {\n                        multipart_params_obj.accept = 'text/plain; charset=utf-8';\n                        logger.debug(\"add accept text/plain in multipart params\");\n                    }\n                    // TODO: to support bput\n                    // http://developer.qiniu.com/docs/v6/api/reference/up/bput.html\n                    up.setOption({\n                        'url': qiniuUploadUrl + '/mkblk/' + blockSize,\n                        'multipart': false,\n                        'chunk_size': chunk_size,\n                        'required_features': \"chunks\",\n                        'headers': {\n                            'Authorization': 'UpToken ' + getUptoken(file)\n                        },\n                        'multipart_params': multipart_params_obj\n                    });\n                }\n            } else {\n                logger.debug(\"directUpload because uploader.runtime !== 'html5' || uploader.runtime !== 'flash' || !chunk_size\");\n                // direct upload if runtime is not html5\n                directUpload(up, file, that.key_handler);\n            }\n        });\n\n        logger.debug(\"bind BeforeUpload event\");\n\n        // bind 'UploadProgress' event\n        // calculate upload speed\n        uploader.bind('UploadProgress', function(up, file) {\n            logger.trace(\"UploadProgress event activated\");\n            speedCalInfo.currentTime = new Date().getTime();\n            var timeUsed = speedCalInfo.currentTime - speedCalInfo.startTime; // ms\n            var fileUploaded = file.loaded || 0;\n            if (speedCalInfo.isResumeUpload) {\n                fileUploaded = file.loaded - speedCalInfo.resumeFilesize;\n            }\n            file.speed = (fileUploaded / timeUsed * 1000).toFixed(0) || 0; // unit: byte/s\n        });\n\n        logger.debug(\"bind UploadProgress event\");\n\n        // bind 'ChunkUploaded' event\n        // store the chunk upload info and set next chunk upload url\n        uploader.bind('ChunkUploaded', function(up, file, info) {\n            logger.debug(\"ChunkUploaded event activated\");\n            logger.debug(\"file: \", file);\n            logger.debug(\"info: \", info);\n            var res = that.parseJSON(info.response);\n            logger.debug(\"res: \", res);\n            // ctx should look like '[chunk01_ctx],[chunk02_ctx],[chunk03_ctx],...'\n            ctx = ctx ? ctx + ',' + res.ctx : res.ctx;\n            var leftSize = info.total - info.offset;\n            var chunk_size = up.getOption && up.getOption('chunk_size');\n            chunk_size = chunk_size || (up.settings && up.settings.chunk_size);\n            if (leftSize < chunk_size) {\n                up.setOption({\n                    'url': qiniuUploadUrl + '/mkblk/' + leftSize\n                });\n                logger.debug(\"up.setOption url: \", qiniuUploadUrl + '/mkblk/' + leftSize);\n            }\n            up.setOption({\n                'headers': {\n                    'Authorization': 'UpToken ' + getUptoken(file)\n                }\n            });\n            localStorage.setItem(file.name, that.stringifyJSON({\n                ctx: ctx,\n                percent: file.percent,\n                total: info.total,\n                offset: info.offset,\n                time: (new Date()).getTime()\n            }));\n        });\n\n        logger.debug(\"bind ChunkUploaded event\");\n\n        var retries = qiniuUploadUrls.length;\n\n        // if error is unkown switch upload url and retry\n        var unknow_error_retry = function(file){\n            if (retries-- > 0) {\n                setTimeout(function(){\n                    that.resetUploadUrl();\n                    file.status = plupload.QUEUED;\n                    uploader.stop();\n                    uploader.start();\n                }, 0);\n                return true;\n            }else{\n                retries = qiniuUploadUrls.length;\n                return false;\n            }\n        };\n\n        // bind 'Error' event\n        // check the err.code and return the errTip\n        uploader.bind('Error', (function(_Error_Handler) {\n            return function(up, err) {\n                logger.error(\"Error event activated\");\n                logger.error(\"err: \", err);\n                var errTip = '';\n                var file = err.file;\n                if (file) {\n                    switch (err.code) {\n                        case plupload.FAILED:\n                            errTip = '上传失败。请稍后再试。';\n                            break;\n                        case plupload.FILE_SIZE_ERROR:\n                            var max_file_size = up.getOption && up.getOption('max_file_size');\n                            max_file_size = max_file_size || (up.settings && up.settings.max_file_size);\n                            errTip = '浏览器最大可上传' + max_file_size + '。更大文件请使用命令行工具。';\n                            break;\n                        case plupload.FILE_EXTENSION_ERROR:\n                            errTip = '文件验证失败。请稍后重试。';\n                            break;\n                        case plupload.HTTP_ERROR:\n                            if (err.response === '') {\n                                // Fix parseJSON error ,when http error is like net::ERR_ADDRESS_UNREACHABLE\n                                errTip = err.message || '未知网络错误。';\n                                if (!unknow_error_retry(file)) {\n                                    return;\n                                }\n                                break;\n                            }\n                            var errorObj = that.parseJSON(err.response);\n                            var errorText = errorObj.error;\n                            switch (err.status) {\n                                case 400:\n                                    errTip = \"请求报文格式错误。\";\n                                    break;\n                                case 401:\n                                    errTip = \"客户端认证授权失败。请重试或提交反馈。\";\n                                    break;\n                                case 405:\n                                    errTip = \"客户端请求错误。请重试或提交反馈。\";\n                                    break;\n                                case 579:\n                                    errTip = \"资源上传成功，但回调失败。\";\n                                    break;\n                                case 599:\n                                    errTip = \"网络连接异常。请重试或提交反馈。\";\n                                    if (!unknow_error_retry(file)) {\n                                        return;\n                                    }\n                                    break;\n                                case 614:\n                                    errTip = \"文件已存在。\";\n                                    try {\n                                        errorObj = that.parseJSON(errorObj.error);\n                                        errorText = errorObj.error || 'file exists';\n                                    } catch (e) {\n                                        errorText = errorObj.error || 'file exists';\n                                    }\n                                    break;\n                                case 631:\n                                    errTip = \"指定空间不存在。\";\n                                    break;\n                                case 701:\n                                    errTip = \"上传数据块校验出错。请重试或提交反馈。\";\n                                    break;\n                                default:\n                                    errTip = \"未知错误。\";\n                                    if (!unknow_error_retry(file)) {\n                                        return;\n                                    }\n                                    break;\n                            }\n                            errTip = errTip + '(' + err.status + '：' + errorText + ')';\n                            break;\n                        case plupload.SECURITY_ERROR:\n                            errTip = '安全配置错误。请联系网站管理员。';\n                            break;\n                        case plupload.GENERIC_ERROR:\n                            errTip = '上传失败。请稍后再试。';\n                            break;\n                        case plupload.IO_ERROR:\n                            errTip = '上传失败。请稍后再试。';\n                            break;\n                        case plupload.INIT_ERROR:\n                            errTip = '网站配置错误。请联系网站管理员。';\n                            uploader.destroy();\n                            break;\n                        default:\n                            errTip = err.message + err.details;\n                            if (!unknow_error_retry(file)) {\n                                return;\n                            }\n                            break;\n                    }\n                    if (_Error_Handler) {\n                        _Error_Handler(up, err, errTip);\n                    }\n                }\n                up.refresh(); // Reposition Flash/Silverlight\n            };\n        })(_Error_Handler));\n\n        logger.debug(\"bind Error event\");\n\n        // bind 'FileUploaded' event\n        // intercept the complete of upload\n        // - get downtoken from downtoken_url if bucket is private\n        // - invoke mkfile api to compose chunks if upload strategy is chunk upload\n        uploader.bind('FileUploaded', (function(_FileUploaded_Handler) {\n            return function(up, file, info) {\n                logger.debug(\"FileUploaded event activated\");\n                logger.debug(\"file: \", file);\n                logger.debug(\"info: \", info);\n                var last_step = function(up, file, info) {\n                    if (op.downtoken_url) {\n                        // if op.dowontoken_url is not empty\n                        // need get downtoken before invoke the _FileUploaded_Handler\n                        var ajax_downtoken = that.createAjax();\n                        ajax_downtoken.open('POST', op.downtoken_url, true);\n                        ajax_downtoken.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n                        ajax_downtoken.onreadystatechange = function() {\n                            if (ajax_downtoken.readyState === 4) {\n                                if (ajax_downtoken.status === 200) {\n                                    var res_downtoken;\n                                    try {\n                                        res_downtoken = that.parseJSON(ajax_downtoken.responseText);\n                                    } catch (e) {\n                                        throw ('invalid json format');\n                                    }\n                                    var info_extended = {};\n                                    plupload.extend(info_extended, that.parseJSON(info), res_downtoken);\n                                    if (_FileUploaded_Handler) {\n                                        _FileUploaded_Handler(up, file, that.stringifyJSON(info_extended));\n                                    }\n                                } else {\n                                    uploader.trigger('Error', {\n                                        status: ajax_downtoken.status,\n                                        response: ajax_downtoken.responseText,\n                                        file: file,\n                                        code: plupload.HTTP_ERROR\n                                    });\n                                }\n                            }\n                        };\n                        ajax_downtoken.send('key=' + that.parseJSON(info).key + '&domain=' + op.domain);\n                    } else if (_FileUploaded_Handler) {\n                        _FileUploaded_Handler(up, file, info);\n                    }\n                };\n\n                var res = that.parseJSON(info.response);\n                ctx = ctx ? ctx : res.ctx;\n                // if ctx is not empty\n                //      that means the upload strategy is chunk upload\n                //      befroe the invoke the last_step\n                //      we need request the mkfile to compose all uploaded chunks\n                // else\n                //      invalke the last_step\n                logger.debug(\"ctx: \", ctx);\n                if (ctx) {\n                    var key = '';\n                    logger.debug(\"save_key: \", op.save_key);\n                    if (!op.save_key) {\n                        key = getFileKey(up, file, that.key_handler);\n                        key = key ? '/key/' + that.URLSafeBase64Encode(key) : '';\n                    }\n\n                    var fname = '/fname/' + that.URLSafeBase64Encode(file.name);\n\n                    logger.debug(\"op.x_vars: \", op.x_vars);\n                    var x_vars = op.x_vars,\n                        x_val = '',\n                        x_vars_url = '';\n                    if (x_vars !== undefined && typeof x_vars === 'object') {\n                        for (var x_key in x_vars) {\n                            if (x_vars.hasOwnProperty(x_key)) {\n                                if (typeof x_vars[x_key] === 'function') {\n                                    x_val = that.URLSafeBase64Encode(x_vars[x_key](up, file));\n                                } else if (typeof x_vars[x_key] !== 'object') {\n                                    x_val = that.URLSafeBase64Encode(x_vars[x_key]);\n                                }\n                                x_vars_url += '/x:' + x_key + '/' + x_val;\n                            }\n                        }\n                    }\n\n                    var url = qiniuUploadUrl + '/mkfile/' + file.size + key + fname + x_vars_url;\n\n                    var ie = that.detectIEVersion();\n                    var ajax;\n                    if (ie && ie <= 9) {\n                        ajax = new mOxie.XMLHttpRequest();\n                        mOxie.Env.swf_url = op.flash_swf_url;\n                    }else{\n                        ajax = that.createAjax();\n                    }\n                    ajax.open('POST', url, true);\n                    ajax.setRequestHeader('Content-Type', 'text/plain;charset=UTF-8');\n                    ajax.setRequestHeader('Authorization', 'UpToken ' + that.token);\n                    var onreadystatechange = function(){\n                        logger.debug(\"ajax.readyState: \", ajax.readyState);\n                        if (ajax.readyState === 4) {\n                            localStorage.removeItem(file.name);\n                            var info;\n                            if (ajax.status === 200) {\n                                info = ajax.responseText;\n                                logger.debug(\"mkfile is success: \", info);\n                                last_step(up, file, info);\n                            } else {\n                                info = {\n                                    status: ajax.status,\n                                    response: ajax.responseText,\n                                    file: file,\n                                    code: -200,\n                                    responseHeaders: ajax.getAllResponseHeaders()\n                                };\n                                logger.debug(\"mkfile is error: \", info);\n                                uploader.trigger('Error', info);\n                            }\n                        }\n                    };\n                    if (ie && ie <= 9) {\n                        ajax.bind('readystatechange', onreadystatechange);\n                    }else{\n                        ajax.onreadystatechange = onreadystatechange;\n                    }\n                    ajax.send(ctx);\n                    logger.debug(\"mkfile: \", url);\n                } else {\n                    last_step(up, file, info.response);\n                }\n\n            };\n        })(_FileUploaded_Handler));\n\n        logger.debug(\"bind FileUploaded event\");\n\n        // init uploader\n        uploader.init();\n\n        logger.debug(\"invoke uploader.init()\");\n\n        logger.debug(\"init uploader end\");\n\n        return uploader;\n    };\n\n    /**\n     * get url by key\n     * @param  {String} key of file\n     * @return {String} url of file\n     */\n    this.getUrl = function(key) {\n        if (!key) {\n            return false;\n        }\n        key = encodeURI(key);\n        var domain = this.domain;\n        if (domain.slice(domain.length - 1) !== '/') {\n            domain = domain + '/';\n        }\n        return domain + key;\n    };\n\n    /**\n     * invoke the imageView2 api of Qiniu\n     * @param  {Object} api params\n     * @param  {String} key of file\n     * @return {String} url of processed image\n     */\n    this.imageView2 = function(op, key) {\n        \n        if (!/^\\d$/.test(op.mode)) {\n            return false;\n        }\n\n        var mode = op.mode,\n            w = op.w || '',\n            h = op.h || '',\n            q = op.q || '',\n            format = op.format || '';\n\n        if (!w && !h) {\n            return false;\n        }\n\n        var imageUrl = 'imageView2/' + mode;\n        imageUrl += w ? '/w/' + w : '';\n        imageUrl += h ? '/h/' + h : '';\n        imageUrl += q ? '/q/' + q : '';\n        imageUrl += format ? '/format/' + format : '';\n        if (key) {\n            imageUrl = this.getUrl(key) + '?' + imageUrl;\n        }\n        return imageUrl;\n    };\n\n    /**\n     * invoke the imageMogr2 api of Qiniu\n     * @param  {Object} api params\n     * @param  {String} key of file\n     * @return {String} url of processed image\n     */\n    this.imageMogr2 = function(op, key) {\n        var auto_orient = op['auto-orient'] || '',\n            thumbnail = op.thumbnail || '',\n            strip = op.strip || '',\n            gravity = op.gravity || '',\n            crop = op.crop || '',\n            quality = op.quality || '',\n            rotate = op.rotate || '',\n            format = op.format || '',\n            blur = op.blur || '';\n        //Todo check option\n\n        var imageUrl = 'imageMogr2';\n\n        imageUrl += auto_orient ? '/auto-orient' : '';\n        imageUrl += thumbnail ? '/thumbnail/' + thumbnail : '';\n        imageUrl += strip ? '/strip' : '';\n        imageUrl += gravity ? '/gravity/' + gravity : '';\n        imageUrl += quality ? '/quality/' + quality : '';\n        imageUrl += crop ? '/crop/' + crop : '';\n        imageUrl += rotate ? '/rotate/' + rotate : '';\n        imageUrl += format ? '/format/' + format : '';\n        imageUrl += blur ? '/blur/' + blur : '';\n\n        if (key) {\n            imageUrl = this.getUrl(key) + '?' + imageUrl;\n        }\n        return imageUrl;\n    };\n\n    /**\n     * invoke the watermark api of Qiniu\n     * @param  {Object} api params\n     * @param  {String} key of file\n     * @return {String} url of processed image\n     */\n    this.watermark = function(op, key) {\n        var mode = op.mode;\n        if (!mode) {\n            return false;\n        }\n\n        var imageUrl = 'watermark/' + mode;\n\n        if (mode === 1) {\n            var image = op.image || '';\n            if (!image) {\n                return false;\n            }\n            imageUrl += image ? '/image/' + this.URLSafeBase64Encode(image) : '';\n        } else if (mode === 2) {\n            var text = op.text ? op.text : '',\n                font = op.font ? op.font : '',\n                fontsize = op.fontsize ? op.fontsize : '',\n                fill = op.fill ? op.fill : '';\n            if (!text) {\n                return false;\n            }\n            imageUrl += text ? '/text/' + this.URLSafeBase64Encode(text) : '';\n            imageUrl += font ? '/font/' + this.URLSafeBase64Encode(font) : '';\n            imageUrl += fontsize ? '/fontsize/' + fontsize : '';\n            imageUrl += fill ? '/fill/' + this.URLSafeBase64Encode(fill) : '';\n        } else {\n            // Todo mode3\n            return false;\n        }\n\n        var dissolve = op.dissolve || '',\n            gravity = op.gravity || '',\n            dx = op.dx || '',\n            dy = op.dy || '';\n\n        imageUrl += dissolve ? '/dissolve/' + dissolve : '';\n        imageUrl += gravity ? '/gravity/' + gravity : '';\n        imageUrl += dx ? '/dx/' + dx : '';\n        imageUrl += dy ? '/dy/' + dy : '';\n\n        if (key) {\n            imageUrl = this.getUrl(key) + '?' + imageUrl;\n        }\n        return imageUrl;\n    };\n\n    /**\n     * invoke the imageInfo api of Qiniu\n     * @param  {String} key of file\n     * @return {Object} image info\n     */\n    this.imageInfo = function(key) {\n        if (!key) {\n            return false;\n        }\n        var url = this.getUrl(key) + '?imageInfo';\n        var xhr = this.createAjax();\n        var info;\n        var that = this;\n        xhr.open('GET', url, false);\n        xhr.onreadystatechange = function() {\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                info = that.parseJSON(xhr.responseText);\n            }\n        };\n        xhr.send();\n        return info;\n    };\n\n    /**\n     * invoke the exif api of Qiniu\n     * @param  {String} key of file\n     * @return {Object} image exif\n     */\n    this.exif = function(key) {\n        if (!key) {\n            return false;\n        }\n        var url = this.getUrl(key) + '?exif';\n        var xhr = this.createAjax();\n        var info;\n        var that = this;\n        xhr.open('GET', url, false);\n        xhr.onreadystatechange = function() {\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                info = that.parseJSON(xhr.responseText);\n            }\n        };\n        xhr.send();\n        return info;\n    };\n\n    /**\n     * invoke the exif or imageInfo api of Qiniu\n     * according with type param\n     * @param  {String} ['exif'|'imageInfo']type of info\n     * @param  {String} key of file\n     * @return {Object} image exif or info\n     */\n    this.get = function(type, key) {\n        if (!key || !type) {\n            return false;\n        }\n        if (type === 'exif') {\n            return this.exif(key);\n        } else if (type === 'imageInfo') {\n            return this.imageInfo(key);\n        }\n        return false;\n    };\n\n    /**\n     * invoke api of Qiniu like a pipeline\n     * @param  {Array of Object} params of a series api call\n     * each object in array is options of api which name is set as 'fop' property\n     * each api's output will be next api's input\n     * @param  {String} key of file\n     * @return {String|Boolean} url of processed image\n     */\n    this.pipeline = function(arr, key) {\n        var isArray = Object.prototype.toString.call(arr) === '[object Array]';\n        var option, errOp, imageUrl = '';\n        if (isArray) {\n            for (var i = 0, len = arr.length; i < len; i++) {\n                option = arr[i];\n                if (!option.fop) {\n                    return false;\n                }\n                switch (option.fop) {\n                    case 'watermark':\n                        imageUrl += this.watermark(option) + '|';\n                        break;\n                    case 'imageView2':\n                        imageUrl += this.imageView2(option) + '|';\n                        break;\n                    case 'imageMogr2':\n                        imageUrl += this.imageMogr2(option) + '|';\n                        break;\n                    default:\n                        errOp = true;\n                        break;\n                }\n                if (errOp) {\n                    return false;\n                }\n            }\n            if (key) {\n                imageUrl = this.getUrl(key) + '?' + imageUrl;\n                var length = imageUrl.length;\n                if (imageUrl.slice(length - 1) === '|') {\n                    imageUrl = imageUrl.slice(0, length - 1);\n                }\n            }\n            return imageUrl;\n        }\n        return false;\n    };\n}\n\nvar Qiniu = new QiniuJsSDK();\n\nglobal.Qiniu = Qiniu;\n\nglobal.QiniuJsSDK = QiniuJsSDK;\n\n})( window );\n"]}